\documentclass[11pt,a4paper]{article}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage[capitalise,noabbrev,nameinlink]{cleveref}
\usepackage{extarrows}
\usepackage{float}
\usepackage[margin=2.5cm]{geometry}
\usepackage[unicode=true,pdftex,pdfa]{hyperref}
\usepackage[utf8]{inputenc}
\usepackage{latexsym}
\usepackage{mathpazo} % nice fonts
\usepackage{mathtools}
\usepackage{microtype}
\usepackage[colon]{natbib}
%%
%% Package `semantic` can be used for writing inference rules.
%%
\usepackage{semantic}
\usepackage{slashed}
\usepackage{stmaryrd}
\usepackage[colorinlistoftodos,prependcaption,textsize=tiny]{todonotes}

\hypersetup{
  pdftitle={Specification of the Blockchain Layer},
  breaklinks=true,
  bookmarks=true,
  colorlinks=false,
  linkcolor={blue},
  citecolor={blue},
  urlcolor={blue},
  linkbordercolor={white},
  citebordercolor={white},
  urlbordercolor={white}
}
\floatstyle{boxed}
\restylefloat{figure}

%% Setup for the semantic package
\setpremisesspace{20pt}

\DeclareMathOperator{\dom}{dom}
\DeclareMathOperator{\range}{range}

%%
%% TODO: we should package this
%%
\newcommand{\powerset}[1]{\mathbb{P}~#1}
\newcommand{\restrictdom}{\lhd}
\newcommand{\subtractdom}{\mathbin{\slashed{\restrictdom}}}
\newcommand{\restrictrange}{\rhd}
\newcommand{\union}{\cup}
\newcommand{\unionoverride}{\mathbin{\underrightarrow\cup}}
\newcommand{\uniondistinct}{\uplus}
\newcommand{\var}[1]{\mathit{#1}}
\newcommand{\fun}[1]{\mathsf{#1}}
\newcommand{\type}[1]{\mathsf{#1}}
\newcommand{\signed}[2]{\llbracket #1 \rrbracket_{#2}}
\newcommand{\size}[1]{\left| #1 \right|}
\newcommand{\trans}[2]{\xlongrightarrow[\textsc{#1}]{#2}}
\newcommand{\seqof}[1]{#1^{*}}
\newcommand{\nextdef}{\\[1em]}

%%
%% Types
%%
\newcommand{\TxId}{\type{TxId}}
\newcommand{\Ix}{\type{Ix}}
\newcommand{\Hash}{\type{Hash}}    % addresses as verification key hashes
\newcommand{\BHash}{\type{BHash}}  % block hashes
\newcommand{\Addr}{\type{Addr}}
\newcommand{\Slot}{\type{Slot}}
\newcommand{\Block}{\type{Block}}
\newcommand{\HCert}{\type{HCert}}

\newcommand{\Tx}{\type{Tx}}
\newcommand{\UTxO}{\type{UTxO}}
\newcommand{\Value}{\type{Value}}
% Adding witnesses
\newcommand{\TxIn}{\type{TxIn}}
\newcommand{\TxOut}{\type{TxOut}}
\newcommand{\SKey}{\type{SKey}}
\newcommand{\VKey}{\type{VKey}}
\newcommand{\Sig}{\type{Sig}}
\newcommand{\Data}{\type{Data}}
\newcommand{\Wit}{\type{Wit}}

%%
%% Function and relation names
%%
\newcommand{\hashname}{hash}
\newcommand{\signname}{sign}
\newcommand{\verifyname}{verify}
\newcommand{\delegatename}{delegate}
\newcommand{\validname}{valid}
%% 
%% Functions
%%
\newcommand{\txins}[1]{\fun{txins}\ \var{#1}}
\newcommand{\txouts}[1]{\fun{txouts}\ \var{#1}}
\newcommand{\values}[1]{\fun{values}\ #1}
\newcommand{\balance}[1]{\fun{balance}\ \var{#1}}
\newcommand{\inputs}[1]{\fun{inputs}\ \var{#1}}
\newcommand{\witnesses}[1]{\fun{witnesses}\ \var{#1}}
\newcommand{\sign}[2]{\fun{\signname}\ \var{#1} ~ \var{#2}}
\newcommand{\verify}[3]{\fun{\verifyname} ~ #1 ~ #2 ~ #3}
\newcommand{\serialised}[1]{\llbracket \var{#1} \rrbracket}
\newcommand{\addr}[1]{\fun{addr}\ \var{#1}}
\newcommand{\hash}[1]{\fun{\hashname}\ \var{#1}}
\newcommand{\delegate}[2]{\fun{\delegatename}\ \var{#1} \times \var{#2}}
\newcommand{\valid}[3]{\fun{\validname} ~ #1 ~ #2 ~ #3}
\newcommand{\inout}[3]{\var{#1}\mapsto_{#2}\var{#3}}
\newcommand{\utxo}[1]{\fun{utxo}\ #1}

% \newcommand{\ChainBZBl}{\var{B_0}\var{B_1}\cdots\var{B_l}}
% \newcommand{\ChainBZBlp1}{\var{B_0}\var{B_1}\cdots\var{B_l}\var{B_{l+1}}}

\begin{document}


\title{Specification of the Blockchain Layer}

\author{Marko Dimjašević}

\date{September 28, 2018}

\maketitle

\begin{abstract}
This documents defines a semantics for operations on a blockchain.
\end{abstract}

\tableofcontents
\listoffigures

\section{Introduction}
\label{sec:introduction}

\section{Preliminaries}
\label{sec:preliminaries}

\section{Basic definitions}
\label{sec:basic-definitions}

\section{Auxiliary definitions}
\label{sec:auxil-defin}

\section{State transitions for Blockchain}
\label{sec:state-trans-chain}

\subsection{Properties}
\label{sec:chain-properties}

\begin{figure}[h]
  \emph{Primitive types}
  %
  \begin{align*}
    % & txid \in \TxId & \text{transaction id}\\
    % & ix \in \Ix & \text{index}\\
    & sl \in \Slot & \text{slot time-stamp}\\
    & \Addr = \Hash,\quad hk \in \Addr & \text{address as a key hash}\\
    & sk \in \SKey & \text{signing key}\\
    & vk \in \VKey & \text{verification key}
  \end{align*}
  %
  \emph{Derived types}
  %
  \begin{align*}
    % & txin \in \TxIn & \text{transaction input}\\
    % & \TxOut & \text{transaction output}\\
    & \BHash & \text{block hash}\\
    & hcert \in \HCert & \text{heavyweight delegation certificate}\\
    & sig \in \Sig  & \text{signature}\\
    & data \in \Data  & \text{data}\\
    & \Block = \BHash \times \Slot \times \Data \times \Sig & \\
    & (h, sl, d, \sigma) \in \Block
      & \text{block}
  \end{align*}
  %
  \emph{Functions and relations}
  %
  \begin{align*}
    % & \witnesses{} \in \Tx \mapsto \powerset{(\VKey \times \Sig)}
    % & \text{witnesses of a transaction}\\
    %
    % & \inputs{} \in \Tx \mapsto \TxIn
    % & \text{transaction inputs}\\
    %
    \text{\signname} & \in \SKey \times \Data \mapsto \Sig
      & \text{signature function}\\
    \text{\verifyname} & \in \VKey \times \Data \times \Sig
      & \text{verification relation}\\
    %
    % & \addr{} \in \TxOut \mapsto \Hash
    % & \text{output address} \\
    %
    \text{\hashname} & \in \VKey \mapsto \Hash
      & \text{verification key hash function}\\
    \text{\delegatename} & \in \SKey \mapsto \HCert
      & \text{delegation function}\\
    \text{\validname} & \in \Block \times \VKey \times \HCert
      & \text{block validity relation}
  \end{align*}
  \caption{Definitions associated with the blockchain transition system}
  \label{fig:state-trans-abstract}
\end{figure}

\subsubsection{Block Validity}
\label{sec:block-valid}
A block is valid if:
\begin{enumerate}
\item it is signed by any key for which a current valid heavyweight delegation
  certificate exists that is signed by any key from the genesis block, and
\item in the rolling window of the last $K$ blocks the number of blocks signed
  by the key signing this block is no more than a threshold $K \cdot t$, where
  $t$ is a constant that we will pick in the range $1/5 \leq t \leq 1/4$.
\end{enumerate}

\begin{equation}
  \label{eq:block-valid}
  \forall (sk, vk), m \in \Data, \sigma \in \Sig.\\
  \nextdef
  \verify{vk}{m}{\sigma} \iff \sign{sk}{m} = \sigma
\end{equation}

\begin{equation}
  \label{eq:chain-extension}
  \inference[Chain-extension]
  {\var{B_0}\var{B_1}\cdots\var{B_l} & \valid{\var{B_{l+1}}}{vk}{hcert}
  }
  {{\var{B_0}\var{B_1}\cdots\var{B_l}} \trans{}{\var{B_{l+1}}} {\var{B_0}\var{B_1}\cdots\var{B_l}\var{B_{l+1}}}}
\end{equation}

\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
