\begin{note}
  This section provides a \textbf{proposal} on how the ledger rules can be used
  to build the blockchain ones. It was mainly developed to help me
  understanding what the blockchain layer requires from the ledger layer, and
  the aspects that need to be modeled in the former. In addition, my
  expectation with this section is that we can discuss which tasks should be
  completed in order to finish a first draft of the blockchain and ledger
  specifications, so that we can move forward with the generators. This section
  was not intended as a replacement of the blockchain spec, which can be found
  in a different document.-- Damian Nadales
\end{note}

\subsection{Chain extension}
\label{sec:chain-extension}

The chain extension rule is given in Figure~\ref{fig:rules:chain-extension},
and the definitions used in this rule are presented in
Figure~\ref{fig:defs:chain-extension}. Rule~\ref{eq:rule:chain-extension}
relies on transitions $\trans{bdeleg}{}$, which specify the delegation
behavior, and $\trans{butxo}{}$ which models the evolution of unspent outputs
after applying the transitions in a block. 

\begin{note}
  The protocol constants are currently modeled as a part of the
  chain extension environment. Once we adding voting
  (the mechanism which controls the protocol constants)
  to the model, it will probably make sense to move them to the
  chain extension states. The protocol constants will also be
  added to the ledger state, along with some kind of rule which
  combines voting with the UTxO rule:
  \begin{equation*}
    \inference[Voting-combine]
    {
      \var{pc} \trans{voting}{} \var{pc'} &
      \var{pc'} \vdash \var{utxo} \trans{utxo}{} \var{utxo'}\\ ~ \\
    }
    {\ldots}
  \end{equation*}
\end{note}

\begin{figure}
  \emph{Abstract types}
  \begin{equation*}
    \begin{array}{r@{~\in~}lr}
      \var{b} & \Block & \text{block}\\
      \var{s} & \Slot & \text{slot id}\\
    \end{array}
  \end{equation*}
  \emph{Abstract functions}
  \begin{equation*}
    \begin{array}{r@{~\in~}lr}
    \fun{bwit} & \Block \to (\VKey \times \Sig) & \text{block witness}\\
      \fun{bepoch} & \Block \to \Epoch & \text{block epoch}\\
      \fun{bslot} & \Block \to \Slot & \text{block slot id}\\
    \fun{s_0} & \Slot  & \text{slot zero (smallest slot id)}\\
    \end{array}
  \end{equation*}
  \caption{Blockchain extension definitions}
  \label{fig:defs:chain-extension}
\end{figure}

\begin{figure}
  \emph{Chain extension environments}
  \begin{equation*}
    \CEEnv =
    \left(
      \begin{array}{r@{~\in~}lr}
        \var{\Gkeys} & \powerset{\VKeyGen} & \text{genesis keys}\\
        \var{K} & \mathbb{N} & \text{number of nodes}\\
        \var{t} & \mathbb{Q} & \text{byzantine nodes ratio}\\
        \var{d} & \Epoch & \text{delegation liveness parameter}\\
        \var{pc} & \PrtclConsts & \text{protocol constants}\\
      \end{array}
    \right)
  \end{equation*}
  \emph{Chain extension states}
  \begin{equation*}
    \CEState =
    \left(
      \begin{array}{r@{~\in~}lr}
        \var{utxo} & \UTxO & \text{blockchain unspent outputs}\\
        \var{dmap} & \VKeyGen \mapsto \VKey & \text{blockchain delegation map}\\
        \var{signers} & \seqof{\VKeyGen} & \text{last $K$ blockchain signers}\\
        \var{sid_c} & \Slot & \text{current slot}\\
        \var{pdlgs} & \Slot \mapsto \seqof{\DCert} & \text{pending delegations}\\
        \var{ekeys} & \Epoch \times \powerset{\VKeyGen} & \text{keys delegated in the current epoch}
      \end{array}
    \right)
  \end{equation*}
  \emph{Chain extension transitions}
  \begin{equation*}
    \_ \vdash \_ \trans{chain}{\_} \_ \in
      \powerset (\CEEnv \times \CEState \times \Block \times \CEState)
  \end{equation*}
  \caption{Chain extension transition-system types}
  \label{fig:ts-types:chain-extension}
\end{figure}

\begin{figure}
  \begin{equation}
    \label{eq:rule:chain-base}
    \inference[Chain-base]
    {}
    {{\begin{array}{l}
         \Gkeys\\
         \wcard\\
         \wcard\\
         \wcard
      \end{array}}
      \vdash
      \left(
        \begin{array}{l}
          \var{utxo}\\
          \var{\{ (\var{vk}, \var{vk}) \mid \var{vk} \in \Gkeys\}}\\
          \emptyset\\
          \var{s_0}\\
          \emptyset\\
          \emptyset
        \end{array}
      \right)
    }
  \end{equation}

  \begin{equation}
    \label{eq:rule:chain-extension}
    \inference[Chain-ext]
    { \fun{bepoch}~b = \var{epo_c}
      & \bslot{b} = \var{sid_n} 
      & \var{sid_c} < \var{sid_n} \\
      {\begin{array}{l}
         \var{epo_c}\\
         \var{sid_n}\\
         d
       \end{array}}
      \vdash
      {
        \left(
          \begin{array}{l}
            \var{dmap}\\
            \var{pdlgs}\\
            \var{ekeys}
          \end{array}
        \right)
      }
      \trans{bdeleg}{b}
      {
        \left(
          \begin{array}{r}
            \var{dmap'}\\
            \var{pdlgs'}\\
            \var{ekeys'}
          \end{array}
        \right)
      }
      \\
      {\begin{array}{l}
         K\\
         t\\
         \var{sid_n}\\
         \var{dmap'}
      \end{array}}
      \vdash
      {
        \left(
          \begin{array}{l}
            \var{signers}
          \end{array}
        \right)
      }
      \trans{BSIGN}{b}
      {
        \left(
          \begin{array}{l}
            \var{signers'}
          \end{array}
        \right)
      }      
      &
      {
        \var{pc} \vdash
        \left(
          \begin{array}{l}
            \var{utxo}\\
          \end{array}
        \right)
      }
      \trans{butxo}{b}
      {
        \left(
          \begin{array}{r}
            \var{utxo'}\\
          \end{array}
        \right)
      }
    }
    {
      {\begin{array}{l}
         \Gkeys\\
         K\\
         t\\
         d\\
         pc
      \end{array}}
      \vdash
      {
        \left(
          \begin{array}{l}
            \var{utxo}\\
            \var{dmap}\\
            \var{signers}\\
            \var{sid_c}\\
            \var{pdlgs}\\
            \var{ekeys}
          \end{array}
        \right)
      }
      \trans{chain}{b}
      {
        \left(
          \begin{array}{l}
            \var{utxo}\\
            \var{dmap'}\\
            \var{signers'}\\
            \var{sid_n}\\
            \var{pdlgs'}\\
            \var{ekeys'}
          \end{array}
        \right)
      }
    }
  \end{equation}
  \caption{Chain extension rules}
  \label{fig:rules:chain-extension}
\end{figure}


\begin{figure}
  \begin{equation}
    \label{eq:rule:block-signing}
    \inference[Chain-ext]
    {\var{vk_g} \mapsto vk_d \in \var{dmap} & \bwit{b} = (\var{vk_d}, \sigma)\\
      \size{\{vk_g\} \restrictdom signers} \leq K * t &
      \verify{vk_d}{\serialised{\bbody{b}}}{\sigma} \\
      \var{signers'} =
         \{ \var{sid} \mapsto \var{vk}
          \mid  \var{sid} \mapsto \var{vk} \in \var{signers} \cup \{\var{sid_c} \mapsto vk_g\}
          , \var{sid_c} - K \leq \var{sid} \}
    }
    {
      {\begin{array}{l}
         K\\
         t\\
         \var{sid_c}\\
         \var{dmap}
      \end{array}}
      \vdash
      {
        \left(
          \begin{array}{l}
            \var{signers}
          \end{array}
        \right)
      }
      \trans{BSIGN}{b}
      {
        \left(
          \begin{array}{l}
            \var{signers'}
          \end{array}
        \right)
      }
    }
  \end{equation}
  \caption{Block signing rules}
  \label{fig:rules:block-signing}
\end{figure}
